#!/bin/sh
# shellcheck disable=SC3043

##? prj - project jumper
SCRIPT_PATH="$(cd "$(dirname "$0")" && pwd)/$(basename "$0")"

# Common helpers
die()    { warn "$@"; exit "${ERR:-1}"; }
say()    { printf '%s\n' "$@"; }
warn()   { say "$@" >&2; }
noop()   { :; }
is_cmd() { command -v "$1" >/dev/null 2>&1; }
is_cmd local || alias local=noop

# Check dependencies
if ! is_cmd fzf; then
  die "fzf command not found"
elif ! is_cmd fd; then
  die "fd command not found"
fi

# Print usage information
usage() {
  say "prj:    The project jumper"
  say "usage:  prj [-h] [-i <shell>] [<query...>]"
}

# Initialize sh/bash/zsh
init_sh() {
  cat <<EOF
prj() {
  MY_SELECTION="\$("$SCRIPT_PATH" \$@)"
  if [ -n "\$MY_SELECTION" ] && [ -d "\$MY_SELECTION" ]; then
    cd "\$MY_SELECTION"
  else
    echo "\$MY_SELECTION"
  fi
  unset MY_SELECTION
}
# eval "\$("$SCRIPT_PATH" -i sh)"
EOF
}

# Initialize fish
init_fish() {
  cat <<EOF
function prj
    set selection ("$SCRIPT_PATH" \$argv)
    if test -n "\$selection" && test -d "\$selection"
        cd "\$selection"
    else
        echo "\$selection"
    end
end
# "$SCRIPT_PATH" -i fish | source
EOF
}

# Main function
main() {
  local show_help show_version init_shell query selection PROJECT_DIR
  PROJECT_DIR="${PROJECT_DIR:-$HOME/Projects}"

  # Parse options - just set variables
  while getopts "hi:v" opt; do
    case $opt in
      h) show_help=1 ;;
      v) show_version=1 ;;
      i) init_shell="$OPTARG" ;;
      ?) ERR=2 die ;;  # Error message already printed by getopts
    esac
  done

  # Collect query parameters
  shift $((OPTIND-1))
  query="$*"

  # Handle actions based on parsed options
  if [ "${show_help:-0}" -eq 1 ]; then
    usage
    exit 0
  elif [ "${show_version:-0}" -eq 1 ]; then
    say "prj ver 1.0.1"
    exit 0
  fi

  if [ -n "$init_shell" ]; then
    case "$init_shell" in
      sh|zsh|bash)
        init_sh
        exit 0
        ;;
      fish)
        init_fish
        exit 0
        ;;
      *)
        ERR=2 die "prj: Unsupported shell '$init_shell'"
        ;;
    esac
  fi

  # Handle tilde expansion
  case "$PROJECT_DIR" in
    ~*) PROJECT_DIR="$HOME${PROJECT_DIR#~}" ;;
  esac

  # Check project directory exists
  if [ ! -d "$PROJECT_DIR" ]; then
    die "prj: Project home directory not found '$PROJECT_DIR'"
  fi

  # Find and select project
  selection=$(
    fd --type d --base-directory "$PROJECT_DIR" --hidden --max-depth 5 '\.git$' |
    sed -e "s|/.git/$||" |
    sort |
    fzf --layout=reverse-list --query="$query"
  )

  # Output the selected project directory
  if [ -n "$selection" ] && [ -d "$PROJECT_DIR/$selection" ]; then
    say "$PROJECT_DIR/$selection"
  fi
}

# Run the script
main "$@"
